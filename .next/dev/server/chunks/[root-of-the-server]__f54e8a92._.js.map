{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/i-e-school-admin-panel/app/api/attendance/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { neon } from '@neondatabase/serverless'\r\n\r\nconst sql = neon(process.env.DATABASE_URL!)\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const className = searchParams.get('class_name')\r\n    const date = searchParams.get('date')\r\n\r\n    if (!className || !date) {\r\n      return NextResponse.json(\r\n        { error: 'Class name and date are required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    const attendance = await sql`\r\n      SELECT * FROM attendance \r\n      WHERE class_name = ${className} \r\n        AND date = ${date}\r\n      ORDER BY student_name\r\n    `\r\n    \r\n    return NextResponse.json(attendance)\r\n  } catch (error) {\r\n    console.error('Error fetching attendance:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to fetch attendance' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { class_name, date, records } = await request.json()\r\n    \r\n    if (!class_name || !date || !records || !Array.isArray(records)) {\r\n      return NextResponse.json(\r\n        { error: 'Class name, date, and records array are required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Check if class exists\r\n    const [classExists] = await sql`\r\n      SELECT * FROM classes WHERE name = ${class_name}\r\n    `\r\n    \r\n    if (!classExists) {\r\n      return NextResponse.json(\r\n        { error: 'Class does not exist' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Delete existing attendance for this class and date\r\n    await sql`\r\n      DELETE FROM attendance \r\n      WHERE class_name = ${class_name} \r\n        AND date = ${date}\r\n    `\r\n\r\n    // Insert new attendance records\r\n    for (const record of records) {\r\n      const { student_id, student_name, status } = record\r\n      \r\n      // Check if student exists and is in the correct class\r\n      const [studentExists] = await sql`\r\n        SELECT * FROM students \r\n        WHERE id = ${student_id} \r\n          AND class_name = ${class_name}\r\n      `\r\n      \r\n      if (!studentExists) {\r\n        return NextResponse.json(\r\n          { error: `Student ${student_name} is not in class ${class_name}` },\r\n          { status: 400 }\r\n        )\r\n      }\r\n\r\n      // Validate status\r\n      const validStatuses = ['Present', 'Absent']\r\n      if (!validStatuses.includes(status)) {\r\n        return NextResponse.json(\r\n          { error: `Invalid status for student ${student_name}` },\r\n          { status: 400 }\r\n        )\r\n      }\r\n\r\n      await sql`\r\n        INSERT INTO attendance (student_id, student_name, class_name, date, status)\r\n        VALUES (${student_id}, ${student_name}, ${class_name}, ${date}, ${status})\r\n        ON CONFLICT (student_id, date) \r\n        DO UPDATE SET status = EXCLUDED.status, created_at = NOW()\r\n      `\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { message: 'Attendance saved successfully' },\r\n      { status: 200 }\r\n    )\r\n  } catch (error) {\r\n    console.error('Error saving attendance:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to save attendance' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;AAElC,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,OAAO,aAAa,GAAG,CAAC;QAE9B,IAAI,CAAC,aAAa,CAAC,MAAM;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmC,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,aAAa,MAAM,GAAG,CAAC;;yBAER,EAAE,UAAU;mBAClB,EAAE,KAAK;;IAEtB,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA6B,GACtC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,UAAU,EAAE,IAAI,EAAE,OAAO,EAAE,GAAG,MAAM,QAAQ,IAAI;QAExD,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,WAAW,CAAC,MAAM,OAAO,CAAC,UAAU;YAC/D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmD,GAC5D;gBAAE,QAAQ;YAAI;QAElB;QAEA,wBAAwB;QACxB,MAAM,CAAC,YAAY,GAAG,MAAM,GAAG,CAAC;yCACK,EAAE,WAAW;IAClD,CAAC;QAED,IAAI,CAAC,aAAa;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QAEA,qDAAqD;QACrD,MAAM,GAAG,CAAC;;yBAEW,EAAE,WAAW;mBACnB,EAAE,KAAK;IACtB,CAAC;QAED,gCAAgC;QAChC,KAAK,MAAM,UAAU,QAAS;YAC5B,MAAM,EAAE,UAAU,EAAE,YAAY,EAAE,MAAM,EAAE,GAAG;YAE7C,sDAAsD;YACtD,MAAM,CAAC,cAAc,GAAG,MAAM,GAAG,CAAC;;mBAErB,EAAE,WAAW;2BACL,EAAE,WAAW;MAClC,CAAC;YAED,IAAI,CAAC,eAAe;gBAClB,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,CAAC,QAAQ,EAAE,aAAa,iBAAiB,EAAE,YAAY;gBAAC,GACjE;oBAAE,QAAQ;gBAAI;YAElB;YAEA,kBAAkB;YAClB,MAAM,gBAAgB;gBAAC;gBAAW;aAAS;YAC3C,IAAI,CAAC,cAAc,QAAQ,CAAC,SAAS;gBACnC,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,CAAC,2BAA2B,EAAE,cAAc;gBAAC,GACtD;oBAAE,QAAQ;gBAAI;YAElB;YAEA,MAAM,GAAG,CAAC;;gBAEA,EAAE,WAAW,EAAE,EAAE,aAAa,EAAE,EAAE,WAAW,EAAE,EAAE,KAAK,EAAE,EAAE,OAAO;;;MAG3E,CAAC;QACH;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;QAAgC,GAC3C;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA4B,GACrC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}