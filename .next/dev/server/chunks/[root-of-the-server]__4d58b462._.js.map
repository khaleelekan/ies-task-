{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/ies-task-/app/api/search/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { neon } from '@neondatabase/serverless'\r\n\r\n// Initialize Neon database connection\r\nconst sql = neon(process.env.DATABASE_URL!)\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    console.log('Search API called')\r\n    \r\n    const { searchParams } = new URL(request.url)\r\n    const query = searchParams.get('q')?.trim()\r\n    const limit = parseInt(searchParams.get('limit') || '10')\r\n\r\n    console.log('Search query:', query)\r\n\r\n    // Validate search query\r\n    if (!query || query.length < 2) {\r\n      console.log('Query too short')\r\n      return NextResponse.json(\r\n        { \r\n          error: 'Search query must be at least 2 characters long',\r\n          results: []\r\n        },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Check if database connection is available\r\n    if (!process.env.DATABASE_URL) {\r\n      console.error('DATABASE_URL is not set')\r\n      return NextResponse.json(\r\n        { \r\n          error: 'Database connection not configured',\r\n          message: 'DATABASE_URL environment variable is missing'\r\n        },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    const searchPattern = `%${query}%`\r\n    \r\n    console.log('Executing search with pattern:', searchPattern)\r\n\r\n    // Execute the search query - UPDATED TO MATCH YOUR SCHEMA\r\n    const results = await sql`\r\n      -- Search students (using your actual schema)\r\n      SELECT \r\n        id,\r\n        'student' as type,\r\n        name as title,\r\n        email as subtitle,\r\n        class_name as description,\r\n        created_at\r\n      FROM students \r\n      WHERE name ILIKE ${searchPattern}\r\n         OR email ILIKE ${searchPattern}\r\n         OR class_name ILIKE ${searchPattern}\r\n      \r\n      UNION ALL\r\n      \r\n      -- Search classes (using your actual schema)\r\n      SELECT \r\n        id,\r\n        'class' as type,\r\n        name as title,\r\n        teacher as subtitle,\r\n        description,\r\n        created_at\r\n      FROM classes \r\n      WHERE name ILIKE ${searchPattern}\r\n         OR teacher ILIKE ${searchPattern}\r\n         OR description ILIKE ${searchPattern}\r\n      \r\n      UNION ALL\r\n      \r\n      -- Search attendance (using your actual schema)\r\n      SELECT \r\n        id,\r\n        'attendance' as type,\r\n        student_name || ' - ' || class_name as title,\r\n        TO_CHAR(date, 'Mon DD, YYYY') as subtitle,\r\n        'Status: ' || status as description,\r\n        created_at\r\n      FROM attendance \r\n      WHERE student_name ILIKE ${searchPattern}\r\n         OR class_name ILIKE ${searchPattern}\r\n      \r\n      ORDER BY created_at DESC\r\n      LIMIT ${limit}\r\n    `\r\n\r\n    console.log('Search returned', results.length, 'results')\r\n\r\n    // Format results for the frontend\r\n    const formattedResults = results.map((result: any) => {\r\n      let icon = 'üîç'\r\n      let href = ''\r\n      \r\n      switch (result.type) {\r\n        case 'student':\r\n          icon = 'üë§'\r\n          href = `/students/${result.id}`\r\n          break\r\n        case 'class':\r\n          icon = 'üìö'\r\n          href = `/classes/${result.id}`\r\n          break\r\n        case 'attendance':\r\n          icon = '‚úÖ'\r\n          href = `/attendance`\r\n          break\r\n      }\r\n\r\n      return {\r\n        id: result.id,\r\n        type: result.type,\r\n        title: result.title,\r\n        subtitle: result.subtitle,\r\n        description: result.description || '',\r\n        icon,\r\n        href,\r\n        createdAt: result.created_at\r\n      }\r\n    })\r\n\r\n    return NextResponse.json({\r\n      query,\r\n      total: formattedResults.length,\r\n      results: formattedResults\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Search API error details:', error)\r\n    \r\n    // Log specific error information\r\n    if (error instanceof Error) {\r\n      console.error('Error name:', error.name)\r\n      console.error('Error message:', error.message)\r\n      console.error('Error stack:', error.stack)\r\n    }\r\n    \r\n    return NextResponse.json(\r\n      { \r\n        error: 'Failed to perform search',\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n        details: process.env.NODE_ENV === 'development' ? String(error) : undefined\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,sCAAsC;AACtC,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;AAElC,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,QAAQ,GAAG,CAAC;QAEZ,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,QAAQ,aAAa,GAAG,CAAC,MAAM;QACrC,MAAM,QAAQ,SAAS,aAAa,GAAG,CAAC,YAAY;QAEpD,QAAQ,GAAG,CAAC,iBAAiB;QAE7B,wBAAwB;QACxB,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,GAAG;YAC9B,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,SAAS,EAAE;YACb,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,4CAA4C;QAC5C,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;YAC7B,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,SAAS;YACX,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,gBAAgB,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;QAElC,QAAQ,GAAG,CAAC,kCAAkC;QAE9C,0DAA0D;QAC1D,MAAM,UAAU,MAAM,GAAG,CAAC;;;;;;;;;;uBAUP,EAAE,cAAc;wBACf,EAAE,cAAc;6BACX,EAAE,cAAc;;;;;;;;;;;;;uBAatB,EAAE,cAAc;0BACb,EAAE,cAAc;8BACZ,EAAE,cAAc;;;;;;;;;;;;;+BAaf,EAAE,cAAc;6BAClB,EAAE,cAAc;;;YAGjC,EAAE,MAAM;IAChB,CAAC;QAED,QAAQ,GAAG,CAAC,mBAAmB,QAAQ,MAAM,EAAE;QAE/C,kCAAkC;QAClC,MAAM,mBAAmB,QAAQ,GAAG,CAAC,CAAC;YACpC,IAAI,OAAO;YACX,IAAI,OAAO;YAEX,OAAQ,OAAO,IAAI;gBACjB,KAAK;oBACH,OAAO;oBACP,OAAO,CAAC,UAAU,EAAE,OAAO,EAAE,EAAE;oBAC/B;gBACF,KAAK;oBACH,OAAO;oBACP,OAAO,CAAC,SAAS,EAAE,OAAO,EAAE,EAAE;oBAC9B;gBACF,KAAK;oBACH,OAAO;oBACP,OAAO,CAAC,WAAW,CAAC;oBACpB;YACJ;YAEA,OAAO;gBACL,IAAI,OAAO,EAAE;gBACb,MAAM,OAAO,IAAI;gBACjB,OAAO,OAAO,KAAK;gBACnB,UAAU,OAAO,QAAQ;gBACzB,aAAa,OAAO,WAAW,IAAI;gBACnC;gBACA;gBACA,WAAW,OAAO,UAAU;YAC9B;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB;YACA,OAAO,iBAAiB,MAAM;YAC9B,SAAS;QACX;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAE3C,iCAAiC;QACjC,IAAI,iBAAiB,OAAO;YAC1B,QAAQ,KAAK,CAAC,eAAe,MAAM,IAAI;YACvC,QAAQ,KAAK,CAAC,kBAAkB,MAAM,OAAO;YAC7C,QAAQ,KAAK,CAAC,gBAAgB,MAAM,KAAK;QAC3C;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAClD,SAAS,uCAAyC,OAAO,SAAS;QACpE,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}